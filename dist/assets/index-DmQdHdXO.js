(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))i(t);new MutationObserver(t=>{for(const c of t)if(c.type==="childList")for(const l of c.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function a(t){const c={};return t.integrity&&(c.integrity=t.integrity),t.referrerPolicy&&(c.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?c.credentials="include":t.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function i(t){if(t.ep)return;t.ep=!0;const c=a(t);fetch(t.href,c)}})();let I=null,f=!1,g=null,E=!1;const r={age:[],gender:[],maxHistorySize:5},o=document.getElementById("video"),s=document.getElementById("overlay"),h=document.getElementById("statusIndicator"),L=h.querySelector(".status-text");document.getElementById("predictionContent");const y=document.querySelector(".no-detection"),F=document.getElementById("detectionResults"),R=document.getElementById("ageResult"),B=document.getElementById("genderResult"),m=document.getElementById("toggleBtn");async function D(){try{d("Modeller yükleniyor...",!1),await O(),d("Kamera açılıyor...",!1),await k(),d("Hazır - Yüz algılama aktif",!0),S()}catch(e){console.error("Initialization error:",e),d("Hata: "+e.message,!1)}}async function O(){const e="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/";try{await Promise.all([faceapi.nets.tinyFaceDetector.loadFromUri(e),faceapi.nets.ageGenderNet.loadFromUri(e),faceapi.nets.faceLandmark68Net.loadFromUri(e)]),E=!0,console.log("Models loaded successfully")}catch{throw new Error("Model yüklenemedi. İnternet bağlantınızı kontrol edin.")}}async function k(){try{const e={video:{facingMode:"user",width:{ideal:1280},height:{ideal:720}},audio:!1};return I=await navigator.mediaDevices.getUserMedia(e),o.srcObject=I,new Promise(n=>{o.onloadedmetadata=()=>{o.play(),s.width=o.videoWidth,s.height=o.videoHeight,n()}})}catch(e){throw console.error("Camera error:",e),new Error("Kamera erişimi reddedildi veya kamera bulunamadı.")}}function S(){!E||f||(f=!0,g=setInterval(async()=>{await P()},1e3))}function M(){g&&(clearInterval(g),g=null),f=!1,s.getContext("2d").clearRect(0,0,s.width,s.height),p()}async function P(){if(!(!o.videoWidth||!o.videoHeight))try{const e=await faceapi.detectSingleFace(o,new faceapi.TinyFaceDetectorOptions({inputSize:416,scoreThreshold:.5})).withAgeAndGender();if(s.getContext("2d").clearRect(0,0,s.width,s.height),e)if(q(e.detection.box)){W(e.age,e.gender);const i=Y(),t=b();A(i,t)}else C(),p("Yüzünüzü çerçeveye getirin");else C(),p()}catch(e){console.error("Detection error:",e)}}function q(e){const n=o.getBoundingClientRect(),i=document.querySelector(".detection-frame").getBoundingClientRect(),t=n.width/o.videoWidth,c=n.height/o.videoHeight,l=n.left+(o.videoWidth-e.x-e.width)*t,x=n.top+e.y*c,z=e.width*t,H=e.height*c,v=l+z/2,w=x+H/2,u=50;return v>=i.left-u&&v<=i.right+u&&w>=i.top-u&&w<=i.bottom+u}function W(e,n){r.age.push(e),r.gender.push(n),r.age.length>r.maxHistorySize&&r.age.shift(),r.gender.length>r.maxHistorySize&&r.gender.shift()}function Y(){if(r.age.length===0)return 0;const n=r.age.reduce((i,t)=>i+t,0)/r.age.length,a=Math.round(n);return`${a-2}-${a+2}`}function b(){if(r.gender.length===0)return"unknown";const e={};return r.gender.forEach(a=>{e[a]=(e[a]||0)+1}),Object.keys(e).reduce((a,i)=>e[a]>e[i]?a:i)==="male"?"Erkek":"Kadın"}function C(){r.age=[],r.gender=[]}function A(e,n){y.style.display="none",F.style.display="block",R.textContent=e,B.textContent=n}function p(e="Yüzünüzü çerçeveye getirin"){F.style.display="none",y.style.display="block",y.querySelector("p").textContent=e}function d(e,n){L.textContent=e,n?h.classList.add("active"):h.classList.remove("active")}m.addEventListener("click",()=>{f?(M(),m.querySelector("span").textContent="Başlat",d("Durduruldu",!1)):(S(),m.querySelector("span").textContent="Durdur",d("Hazır - Yüz algılama aktif",!0))});window.addEventListener("resize",()=>{o.videoWidth&&o.videoHeight&&(s.width=o.videoWidth,s.height=o.videoHeight)});window.addEventListener("DOMContentLoaded",D);
